# Сервери фиристодани почтаи SMTP-и худро созед

## муқаддима

SMTP метавонад мустақиман хидматҳоро аз фурӯшандагони абр харидорӣ кунад, ба монанди:

* [Amazon SES SMTP](https://docs.aws.amazon.com/ses/latest/dg/send-email-smtp.html)
* [Али абрӣ пахши почтаи электронӣ](https://www.alibabacloud.com/help/directmail/latest/three-mail-sending-methods)

Шумо инчунин метавонед сервери почтаи худро созед - фиристодани номаҳдуд, арзиши умумии кам.

Дар зер, мо қадам ба қадам нишон медиҳем, ки чӣ тавр сохтани сервери почтаи шахсии худамон.

## Интихоби сервер

Сервери худидоракунии SMTP IP-и ҷамъиятиро бо портҳои 25, 456 ва 587 кушода талаб мекунад.

Абрҳои маъмулан истифодашаванда ин бандарҳоро ба таври нобаёнӣ бастаанд ва мумкин аст, ки онҳоро бо додани фармоиши корӣ кушоед, аммо ин ниҳоят мушкил аст.

Ман тавсия медиҳам, ки аз хосте харед, ки ин портҳо кушода аст ва танзими номи доменҳои баръаксро дастгирӣ мекунад.

Дар ин ҷо ман [Contabo-ро](https://contabo.com) тавсия медиҳам.

Contabo як провайдери хостинг дар Мюнхен, Олмон аст, ки соли 2003 бо нархҳои хеле рақобатпазир таъсис ёфтааст.

Агар шумо евроро ҳамчун асъори харид интихоб кунед, нарх арзонтар мешавад (сервер бо хотираи 8 ГБ ва 4 CPU дар як сол тақрибан 529 юан арзиш дорад ва пардохти ибтидоии насб барои як сол ройгон аст).

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/UoAQkwY.webp)

Ҳангоми фармоиш, қайд кунед, `prefer AMD` ва сервери дорои CPU AMD беҳтар кор хоҳад кард.

Дар зер, ман VPS-и Contabo-ро ҳамчун намуна мегирам, то нишон диҳам, ки чӣ тавр сохтани сервери почтаи шахсии шумо.

## Конфигуратсияи системаи Ubuntu

Системаи оператсионии ин ҷо Ubuntu 22.04 мебошад

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/smpIu1F.webp)

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/m7Mwjwr.webp)

Агар сервер дар ssh нишон диҳад `Welcome to TinyCore 13!` (тавре ки дар расми зер нишон дода шудааст), ин маънои онро дорад, ки система то ҳол насб нашудааст. Лутфан ssh-ро ҷудо кунед ва барои дубора ворид шудан чанд дақиқа интизор шавед.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/-qKACz9.webp)

Вақте ки `Welcome to Ubuntu 22.04.1 LTS` пайдо мешавад, оғозсозӣ ба анҷом мерасад ва шумо метавонед бо қадамҳои зерин идома диҳед.

### [Ихтиёрӣ] Муҳити рушдро оғоз кунед

Ин қадам ихтиёрӣ аст.

Барои роҳат, ман насб ва конфигуратсияи системаи нармафзори ubuntu-ро дар [github.com/wactax/ops.os/tree/main/ubuntu](https://github.com/wactax/ops.os/tree/main/ubuntu) гузоштам.

Фармони зеринро иҷро кунед, то бо як клик насб кунед.

```
bash <(curl -s https://raw.githubusercontent.com/wactax/ops.os/main/ubuntu/boot.sh)
```

Корбарони чинӣ, лутфан ба ҷои ин фармонро истифода баред ва забон, минтақаи вақт ва ғайра ба таври худкор муқаррар карда мешавад.

```
CN=1 bash <(curl -s https://ghproxy.com/https://raw.githubusercontent.com/wactax/ops.os/main/ubuntu/boot.sh)
```

### Contabo IPV6-ро фаъол мекунад

IPV6-ро фаъол созед, то SMTP инчунин бо суроғаҳои IPV6 паёмҳои электронӣ фиристад.

таҳрир кунед `/etc/sysctl.conf`

Сатрҳои зеринро тағир диҳед ё илова кунед

```
net.ipv6.conf.all.disable_ipv6 = 0
net.ipv6.conf.default.disable_ipv6 = 0
net.ipv6.conf.lo.disable_ipv6 = 0
```

Бо [дастури контабо пайравӣ кунед: Илова кардани пайвасти IPv6 ба сервери шумо](https://contabo.com/blog/adding-ipv6-connectivity-to-your-server/)

`/etc/netplan/01-netcfg.yaml` -ро таҳрир кунед, чанд сатрро тавре, ки дар расми зер нишон дода шудааст, илова кунед (файли конфигуратсияи конфигуратсияи пешфарз Contabo VPS аллакай ин сатрҳоро дорад, танҳо онҳоро шарҳ диҳед).

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/5MEi41I.webp)

Сипас `netplan apply` , то конфигуратсияи тағирёфта эътибор пайдо кунад.

Пас аз бомуваффақияти конфигуратсия, шумо метавонед `curl 6.ipw.cn` барои дидани суроғаи ipv6-и шабакаи берунии худ истифода баред.

## Амалиётҳои анбори конфигуратсияро клон кунед

```
git clone https://github.com/wactax/ops.soft.git
```

## Барои номи домени худ сертификати ройгони SSL эҷод кунед

Ирсоли почта барои рамзгузорӣ ва имзо сертификати SSL-ро талаб мекунад.

Мо барои тавлиди сертификатҳо [acme.sh-ро](https://github.com/acmesh-official/acme.sh) истифода мебарем.

acme.sh воситаи имзои сертификати автоматии кушодаасос аст,

Анбори конфигуратсияро ops.soft ворид кунед, `./ssl.sh` иҷро кунед ва дар **феҳристи боло** папкаи `conf` эҷод мешавад.

Провайдери DNS-и худро аз [acme.sh dnsapi](https://github.com/acmesh-official/acme.sh/wiki/dnsapi) пайдо кунед, `conf/conf.sh` таҳрир кунед.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/Qjq1C1i.webp)

Сипас `./ssl.sh 123.com` иҷро кунед, то шаҳодатномаҳои `123.com` ва `*.123.com` барои номи домени худ тавлид кунед.

Давраи аввал ба таври худкор [acme.sh-ро](https://github.com/acmesh-official/acme.sh) насб мекунад ва вазифаи ба нақша гирифташударо барои навсозии худкор илова мекунад. Шумо метавонед `crontab -l` бубинед, чунин сатр вуҷуд дорад.

```
52 0 * * * "/mnt/www/.acme.sh"/acme.sh --cron --home "/mnt/www/.acme.sh" > /dev/null
```

Роҳи сертификати тавлидшуда ба монанди `/mnt/www/.acme.sh/123.com_ecc。`

Таҷдиди сертификат скрипти `conf/reload/123.com.sh` -ро даъват мекунад, ин скриптро таҳрир кунед, шумо метавонед фармонҳоро ба монанди `nginx -s reload` илова кунед, то кэши сертификати замимаҳои дахлдорро навсозӣ кунед.

## Бо chasquid сервери SMTP созед

[chasquid](https://github.com/albertito/chasquid) сервери кушодаи SMTP мебошад, ки бо забони Go навишта шудааст.

Ҳамчун ҷойгузини барномаҳои сервери почтаи қадимӣ, аз қабили Postfix ва Sendmail, chasquid соддатар ва осонтар истифода мешавад ва инчунин барои рушди дуввум осонтар аст.

`./chasquid/init.sh 123.com` бо як клик ба таври худкор насб карда мешавад (123.com-ро бо номи домени фиристодаи худ иваз кунед).

## Имзои почтаи электронии DKIM-ро танзим кунед

DKIM барои фиристодани имзоҳои почтаи электронӣ истифода мешавад, то мактубҳоро ҳамчун спам пешгирӣ кунад.

Пас аз бомуваффақият иҷро шудани фармон, аз шумо хоҳиш карда мешавад, ки сабти DKIM-ро насб кунед (тавре ки дар зер нишон дода шудааст).

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/LJWGsmI.webp)

Танҳо сабти TXT ба DNS-и худ илова кунед (тавре ки дар зер нишон дода шудааст).

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/0szKWqV.webp)

## Ҳолати хидмат ва гузоришҳоро дидан

 `systemctl status chasquid` View ҳолати хидматрасонӣ.

Ҳолати кори муқаррарӣ дар расми зер нишон дода шудааст

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/CAwyY4E.webp)

 `grep chasquid /var/log/syslog` ё `journalctl -xeu chasquid` метавонад сабти хатогиҳоро бубинад.

## Конфигуратсияи номи домени баръакс

Номи домени баръакс имкон медиҳад, ки суроғаи IP ба номи домени мувофиқ ҳал карда шавад.

Муқаррар кардани номи домени баръакс метавонад аз муайян кардани спам почтаи электронӣ пешгирӣ кунад.

Вақте ки паём қабул мешавад, сервери қабулкунанда дар суроғаи IP-и сервери ирсолкунанда таҳлили номи домени баръакс анҷом медиҳад, то тасдиқ кунад, ки сервери ирсолкунанда дорои номи домени баръакси дуруст дорад.

Агар сервери ирсолкунанда номи домени баръакс надошта бошад ё номи домени баръакс ба суроғаи IP-и сервери ирсолкунанда мувофиқат накунад, сервери қабулкунанда метавонад почтаи электрониро ҳамчун спам эътироф кунад ё онро рад кунад.

Ба [https://my.contabo.com/rdns](https://my.contabo.com/rdns) равед ва тавре ки дар зер нишон дода шудааст, танзим кунед

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/IIPdBk_.webp)

Пас аз гузоштани номи домени баръакс, фаромӯш накунед, ки ҳалли пешбари номи домени ipv4 ва ipv6-ро ба сервер танзим кунед.

## Номи мизбони chasquid.conf-ро таҳрир кунед

Тағир `conf/chasquid/chasquid.conf` ба арзиши номи домени баръакс.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/6Fw4SQi.webp)

Сипас `systemctl restart chasquid` иҷро кунед, то хидматро аз нав оғоз кунед.

## Нусхабардории conf ба анбори git

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/Fier9uv.webp)

Масалан, ман ҷузвдони conf-ро ба раванди github-и худ ба таври зерин нусхабардорӣ мекунам

Аввал як анбори хусусӣ созед

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/ZSCT1t1.webp)

Феҳристи conf-ро ворид кунед ва ба анбор пешниҳод кунед

```
git init
git add .
git commit -m "init"
git branch -M main
git remote add origin git@github.com:wac-tax-key/conf.git
git push -u origin main
```

## Иловаи ирсолкунанда

давидан

```
chasquid-util user-add i@wac.tax
```

Метавонед ирсолкунандаро илова кунед

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/khHjLof.webp)

### Боварӣ ҳосил кунед, ки парол дуруст гузошта шудааст

```
chasquid-util authenticate i@wac.tax --password=xxxxxxx
```

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/e92JHXq.webp)

Пас аз илова кардани корбар, `chasquid/domains/wac.tax/users` навсозӣ мешавад, фаромӯш накунед, ки онро ба анбор пешниҳод кунед.

## DNS сабти SPF-ро илова мекунад

SPF (Sender Policy Framework) технологияи тасдиқи почтаи электронӣ мебошад, ки барои пешгирии қаллобии почтаи электронӣ истифода мешавад.

Он шахсияти ирсолкунандаи почтаи электрониро тавассути тафтиш кардани он, ки суроғаи IP-и ирсолкунанда ба сабтҳои DNS-и номи домене, ки он даъво дорад, мувофиқат мекунад ва аз фиристодани паёмҳои қалбакӣ аз қаллобон пешгирӣ мекунад.

Илова кардани сабтҳои SPF метавонад то ҳадди имкон спам муайян шудани паёмҳои электрониро пешгирӣ кунад.

Агар сервери номи домени шумо намуди SPF-ро дастгирӣ накунад, танҳо сабти навъи TXT-ро илова кунед.

Масалан, SPF-и `wac.tax` чунин аст

`v=spf1 a mx include:_spf.wac.tax include:_spf.google.com ~all`

SPF барои `_spf.wac.tax`

`v=spf1 a:smtp.wac.tax ~all`

Аҳамият диҳед, ки ман дар ин ҷо `include:_spf.google.com` , зеро ман `i@wac.tax` ҳамчун суроғаи ирсолкунанда дар қуттии почтаи Google баъдтар танзим мекунам.

## Танзимоти DNS DMARC

DMARC ихтисораи (Authentication Message-based Domain, Reporting & Conformance) мебошад.

Он барои сабт кардани спамҳои SPF истифода мешавад (шояд аз хатогиҳои конфигуратсия ба вуҷуд омада бошад ё ягон каси дигар вонамуд кунад, ки шумо спам мефиристед).

Иловаи сабти TXT `_dmarc` ,

Мазмуни он чунин аст

```
v=DMARC1; p=quarantine; fo=1; ruf=mailto:ruf@wac.tax; rua=mailto:rua@wac.tax
```

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/k44P7O3.webp)

Маънои ҳар як параметр чунин аст

### p (Сиёсат)

Нишон медиҳад, ки чӣ тавр коркарди паёмҳои электронӣ, ки аз санҷиши SPF (Sender Policy Framework) ё DKIM (DomainKeys Identified Mail) ноком мешаванд. Параметри p метавонад ба яке аз се арзиш муқаррар карда шавад:

* ҳеҷ: Ҳеҷ гуна чора андешида намешавад, танҳо натиҷаи санҷиш тавассути механизми гузоришдиҳии почтаи электронӣ ба ирсолкунанда бармегардад.
* Карантин: Почтаеро, ки аз санҷиш нагузаштааст, ба ҷузвдони спам гузоред, аммо паёмро мустақиман рад намекунад.
* рад: мустақиман рад почтаи электронӣ, ки ба тафтиш ноком.

### fo (Имконоти ноком)

Миқдори иттилооти баргардонидашудаи механизми ҳисоботро муайян мекунад. Он метавонад ба яке аз арзишҳои зерин муқаррар карда шавад:

* 0: Натоиҷи тасдиқи ҳама паёмҳоро гузориш диҳед
* 1: Танҳо паёмҳоеро гузориш диҳед, ки тафтиш карда намешаванд
* d: Танҳо дар бораи нокомии тасдиқи номи домен гузориш диҳед
* s: танҳо дар бораи нокомии санҷиши SPF гузориш диҳед
* l: Танҳо дар бораи нокомии санҷиши DKIM гузориш диҳед

### rua & ruf

* rua (Ҳисоботи URI барои ҳисоботҳои маҷмӯӣ): Суроғаи почтаи электронӣ барои гирифтани ҳисоботи ҷамъшуда
* ruf (Ҳисоботи URI барои ҳисоботҳои криминалистӣ): суроғаи почтаи электронӣ барои гирифтани ҳисоботи муфассал

## Барои фиристодани мактубҳо ба Google Mail сабтҳои MX илова кунед

Азбаски ман қуттии почтаи корпоративии ройгонеро, ки суроғаҳои универсалиро дастгирӣ мекунад, пайдо карда натавонистам (Catch-All, метавонад ҳар гуна мактубҳои ба ин номи домен фиристодашударо бидуни маҳдудият дар префиксҳо қабул кунад), ман chasquidро барои фиристодани ҳама мактубҳо ба паёмдони Gmail-и худ истифода кардам.

**Агар шумо паёмдони тиҷоратии худро дошта бошед, лутфан MX-ро тағир надиҳед ва ин қадамро гузаред.**

Таҳрири `conf/chasquid/domains/wac.tax/aliases` , танзим кардани паёмдони интиқол

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/OBDl2gw.webp)

`*` ҳамаи мактубҳоро нишон медиҳад, `i` префикси суроғаи почтаи электронии корбари ирсолкунанда мебошад, ки дар боло сохта шудааст. Барои фиристодани почта, ҳар як корбар бояд хат илова кунад.

Сипас сабти MX-ро илова кунед (ман бевосита ба суроғаи номи домени баръакс ишора мекунам, тавре ки дар сатри аввал дар расми зер нишон дода шудааст).

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/7__KrU8.webp)

Пас аз ба итмом расидани конфигуратсия, шумо метавонед суроғаҳои почтаи электронии дигарро барои ирсоли паёмҳо ба `i@wac.tax` ва `any123@wac.tax` истифода баред, то бубинед, ки оё шумо метавонед паёмҳои электрониро дар Gmail қабул кунед.

Дар акси ҳол, сабти chasquid -ро тафтиш кунед ( `grep chasquid /var/log/syslog` ).

## Бо Google Mail ба i@wac.tax паёми электронӣ фиристед

Пас аз он ки Google Mail паёмро гирифт, ман табиатан умедвор будам, ки ба ҷои i.wac.tax@gmail.com бо `i@wac.tax` ҷавоб диҳам.

Ба [https://mail.google.com/mail/u/1/#settings/accounts](https://mail.google.com/mail/u/1/#settings/accounts) ворид шавед ва "Илова кардани суроғаи почтаи электронии дигар" -ро клик кунед.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/PAvyE3C.webp)

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/_OgLsPT.webp)

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/XIUf6Dc.webp)

Сипас, рамзи тасдиқро, ки тавассути почтаи электронӣ фиристода шудааст, ворид кунед.

Ниҳоят, он метавонад ҳамчун суроғаи пешфарз таъин карда шавад (дар баробари имконоти ҷавоб бо ҳамон суроға).

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/a95dO60.webp)

Бо ин роҳ, мо таъсиси сервери почтаи SMTP-ро анҷом додем ва ҳамзамон Google Mail-ро барои ирсол ва қабули мактубҳо истифода мебарем.

## Барои санҷидани он, ки конфигуратсия бомуваффақият аст, паёми электронӣ фиристед

`ops/chasquid` ворид кунед

Иҷроиши `direnv allow` , ки вобастагӣ насб карда шавад (direnv дар раванди оғозкунии қаблии як калид насб шудааст ва қалмоқ ба қабат илова карда шудааст)

баъд давидан

```
user=i@wac.tax pass=xxxx to=iuser.link@gmail.com ./sendmail.coffee
```

Маънои параметрҳо чунин аст

* корбар: номи корбари SMTP
* гузариш: пароли SMTP
* ба: гиранда

Шумо метавонед почтаи электронӣ фиристед.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/ae1iWyM.webp)

Тавсия дода мешавад, ки Gmail-ро барои гирифтани мактубҳои санҷишӣ истифода баред, то бомуваффақияти конфигуратсияҳо тафтиш кунед.

### Рамзгузории стандартии TLS

Тавре ки дар расми зер нишон дода шудааст, ин қулфи хурд мавҷуд аст, ки маънои онро дорад, ки сертификати SSL бомуваффақият фаъол карда шудааст.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/SrdbAwh.webp)

Сипас "Намоиши почтаи аслӣ" -ро клик кунед

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/qQQsdxg.webp)

### ДКИМ

Тавре ки дар расми зер нишон дода шудааст, саҳифаи почтаи аслии Gmail DKIM-ро намоиш медиҳад, ки ин маънои онро дорад, ки конфигуратсияи DKIM муваффақ аст.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/an6aXK6.webp)

Қабулшударо дар сарлавҳаи почтаи аслӣ санҷед ва шумо мебинед, ки суроғаи ирсолкунанда IPV6 аст, яъне IPV6 низ бомуваффақият танзим шудааст.
